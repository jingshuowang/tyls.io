<!DOCTYPE html>
<html>

<head>
    <title>Survival.io - MonoGame Client</title>
    <meta charset="UTF-8">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
        }

        #gameCanvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #0f0;
            font-family: monospace;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div id="status">Connecting to server...</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.2.4/pixi.min.js"></script>
    <script>
        // Pixel-perfect settings
        PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;
        PIXI.settings.ROUND_PIXELS = true;

        const TILE_SIZE = 16;
        const CHUNK_SIZE = 16;
        const SCALE = 3; // Integer scaling for pixel-perfect

        // Create PixiJS app
        const app = new PIXI.Application({
            width: window.innerWidth,
            height: window.innerHeight,
            backgroundColor: 0x87CEEB,
            antialias: false,
            resolution: 1
        });
        document.body.appendChild(app.view);
        app.view.id = 'gameCanvas';

        // World container
        const worldContainer = new PIXI.Container();
        app.stage.addChild(worldContainer);
        worldContainer.scale.set(SCALE);

        // Layers
        const tilesContainer = new PIXI.Container();
        const gridContainer = new PIXI.Container();
        const overlayContainer = new PIXI.Container();
        worldContainer.addChild(tilesContainer);
        worldContainer.addChild(gridContainer);
        worldContainer.addChild(overlayContainer);

        // Load textures
        const grassTexture = await PIXI.Assets.load('grass.png');
        const dirtTexture = await PIXI.Assets.load('dirt.png');

        // Server configuration
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const SERVER_URL = isLocalhost
            ? 'ws://localhost:8080'  // Local development
            : 'ws://YOUR_SERVER_IP:8080';  // Production - replace with your server IP

        // Game state from server
        let serverState = {
            player: { x: 0, y: 0 },
            camera: { x: 0, y: 0 },
            chunks: new Map()
        };

        // Input state
        const keys = {};
        const mouse = { x: 0, y: 0, left: false, right: false };

        // WebSocket connection
        const ws = new WebSocket(SERVER_URL);
        const statusEl = document.getElementById('status');

        ws.onopen = () => {
            console.log('Connected to server!');
            statusEl.textContent = 'Connected!';
            statusEl.style.color = '#0f0';
        };

        ws.onclose = () => {
            console.log('Disconnected from server');
            statusEl.textContent = 'Disconnected';
            statusEl.style.color = '#f00';
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            statusEl.textContent = 'Connection error';
            statusEl.style.color = '#f00';
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === 'full_state') {
                // Initial state
                serverState.player = data.player;
                serverState.camera = data.camera;

                // Load chunks
                data.chunks.forEach(chunk => {
                    const key = `${chunk.x},${chunk.y}`;
                    serverState.chunks.set(key, chunk.tiles);
                    renderChunk(chunk.x, chunk.y, chunk.tiles);
                });
            } else if (data.type === 'state') {
                // Update state
                serverState.player = data.player;
                serverState.camera = data.camera;
            }
        };

        // Send input to server
        function sendInput() {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'input',
                    keys: keys,
                    mouse: mouse
                }));
            }
        }

        // Keyboard input
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });

        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Mouse input
        window.addEventListener('mousemove', (e) => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        });

        window.addEventListener('mousedown', (e) => {
            if (e.button === 0) mouse.left = true;
            if (e.button === 2) mouse.right = true;
        });

        window.addEventListener('mouseup', (e) => {
            if (e.button === 0) mouse.left = false;
            if (e.button === 2) mouse.right = false;
        });

        // Prevent context menu
        window.addEventListener('contextmenu', (e) => e.preventDefault());

        // Render chunk
        const chunkContainers = new Map();

        function getTileTexture(baseTexture, index, cols = 4, tileSize = 16) {
            const col = index % cols;
            const row = Math.floor(index / cols);
            return new PIXI.Texture(
                baseTexture,
                new PIXI.Rectangle(col * tileSize, row * tileSize, tileSize, tileSize)
            );
        }

        function renderChunk(cx, cy, tiles) {
            const key = `${cx},${cy}`;

            // Remove old container
            if (chunkContainers.has(key)) {
                const oldContainer = chunkContainers.get(key);
                tilesContainer.removeChild(oldContainer);
                oldContainer.destroy({ children: true });
            }

            const container = new PIXI.Container();

            for (let ty = 0; ty < CHUNK_SIZE; ty++) {
                for (let tx = 0; tx < CHUNK_SIZE; tx++) {
                    const worldX = cx * CHUNK_SIZE + tx;
                    const worldY = cy * CHUNK_SIZE + ty;
                    const tileValue = tiles[ty][tx];

                    // Dirt (always render)
                    const dirtIdx = Math.floor(Math.random() * 16);
                    const dirtSprite = new PIXI.Sprite(getTileTexture(dirtTexture.baseTexture, dirtIdx));
                    dirtSprite.x = worldX * TILE_SIZE;
                    dirtSprite.y = worldY * TILE_SIZE;
                    dirtSprite.width = TILE_SIZE;
                    dirtSprite.height = TILE_SIZE;
                    container.addChild(dirtSprite);

                    // Grass (if tile is grass)
                    if (tileValue === 0) {
                        const grassIdx = 6; // Full grass tile for now
                        const grassSprite = new PIXI.Sprite(getTileTexture(grassTexture.baseTexture, grassIdx));
                        grassSprite.x = (worldX + 0.5) * TILE_SIZE;
                        grassSprite.y = (worldY + 0.5) * TILE_SIZE;
                        grassSprite.anchor.set(0.5);
                        grassSprite.width = TILE_SIZE;
                        grassSprite.height = TILE_SIZE;
                        container.addChild(grassSprite);
                    }
                }
            }

            tilesContainer.addChild(container);
            chunkContainers.set(key, container);
        }

        // Game loop
        app.ticker.add(() => {
            // Send input
            sendInput();

            // Update camera
            worldContainer.x = -serverState.camera.x * SCALE + app.screen.width / 2;
            worldContainer.y = -serverState.camera.y * SCALE + app.screen.height / 2;

            // Update status
            statusEl.textContent = `Player: (${serverState.player.x.toFixed(1)}, ${serverState.player.y.toFixed(1)})`;
        });

        console.log('Client ready! Waiting for server connection...');
    </script>
</body>

</html>